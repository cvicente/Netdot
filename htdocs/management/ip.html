<%doc>
Interface for IP blocks (both addresses and subnets)
</%doc>
%
%
<%attr>
title   => 'IP' 
section => 'Management'
</%attr>
%
%
<%args>
$id                => undef
$user              => $ui->get_current_user($r)
$search            => undef
$_action           => 'SHOW_ROOTS'
$delete            => undef
$recursivedel      => undef
$add_range_start   => undef
$add_range_end     => undef
$add_block_prefix  => undef
$add_block_parent  => undef
$range_owner       => undef
$range_status      => undef
$range_used_by     => undef
$range_description => undef
$range_gen_dns     => undef
$range_fw_zone     => undef
$name_prefix       => undef
$name_suffix       => undef
$block_owner       => undef
$block_status      => undef
$block_used_by     => undef
$block_description => undef
$newblock          => undef
$parent            => undef
$length            => undef
$edit              => undef
$edit_children     => undef
$editattr          => undef
$submit            => undef
$rootversion       => 4 
$view_format       => Netdot->config->get('DEFAULT_IPBLOCK_VIEW')
$rowsize           => Netdot->config->get('DEFAULT_IPBLOCK_ROWSIZE')
$dividefreespace   => 'max'
$arp_limit         => 10
$ip_list_sort      => 'Address'
$show_ch_util      => 0
$state_digest      => undef
@link_zones        => undef
@new_rev_zones     => undef
$new_a_name        => undef
$new_a_zone        => undef
$template_zone_for_rev => undef
$new_blocks_list   => undef
$new_blocks_status => undef
$tree_version      => undef
$view              => 'Children'
$add_access_type   => undef
$add_access_id     => undef
</%args>
%
%
<%init>
use integer;

my $DEBUG = 0;
my $o;
my $ci = 0;
my $title;
my @list;
my $edit_ip     = ( $edit && $edit eq "ipinfo"    ) ? 1 : 0;
my $edit_block  = ( $edit && $edit eq "blockinfo" ) ? 1 : 0;
my $edit_comments  = ( $edit && $edit eq "comments" ) ? 1 : 0;
my $max_ips     = Netdot->config->get('SHOW_COUNT_THRESHOLD');
my $added_ip    = 0;
my $added_block = 0;
my $covering_block;
my $BLOCK_VIEW_MAX;
my $dns_address_record_label = 'A/AAAA';

print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>' if $DEBUG;

my $manager = $ui->get_permission_manager($r);


if ( $id ){
    if ( $o = Ipblock->retrieve($id) ){
	# Check if user can view this object
	unless ( $manager && $manager->can($user, "view", $o) ){
	    $m->comp('/generic/error.mhtml', error=>"You don't have permission to view this object");
	}
	$title = $o->get_label;
    }else{
	$m->comp('/generic/error.mhtml', error => "Could not retrieve Ipblock id: $id");
    }

    # Block View has some limits
    if ( $o->status->name eq 'Subnet' ){
	$BLOCK_VIEW_MAX = Netdot->config->get('SUBNET_BLOCK_VIEW_MAX_PREFIX');
    }elsif ( $o->status->name eq 'Container' ){
	$BLOCK_VIEW_MAX = Netdot->config->get('CONTAINER_BLOCK_VIEW_MAX_PREFIX');
    }
    if ( $o->version == 4 ){
        $dns_address_record_label = 'A';
	if ( $view_format eq 'block' ){
	    if ( $BLOCK_VIEW_MAX && ($o->prefix < $BLOCK_VIEW_MAX) ){
		$view_format = 'list';
	    }
	}
    }elsif ( $o->version == 6 ){
        $dns_address_record_label = 'AAAA';
	$view_format = 'list' if $view_format eq 'block';
    }

}else{
    $title = "Search";
}

# By default, view object after any operation
# ( some exceptions will override )
my $view_object = 1;

unless ( $view_format =~ /^block|list|tree$/ ){
    $m->comp('/generic/error.mhtml', error => "Invalid view format: $view_format. Perhaps wrongly configured in etc/Site.conf?");
}

</%init>
%
<div id="sectiondetail">

<script language="javascript">
<!--

function edit_recursive(id, field, rec){
    var url = "ip-rec.html?id="+id+"&field="+field+"&recursive="+rec;
    var wind = window.open(url, 'Edit recursively', "width=600,height=200");
}

function setCheckbox(formname, name, val) {
    var form = document.forms[formname];
    var myfield = form.getElementsByTagName('input');
    for ( var i = 0; i < myfield.length; i++ ) {
        if ( name && myfield[i].name != name ) continue;
        if ( myfield[i].type != 'checkbox' ) continue;

        myfield[i].checked = val;
    }
}

-->
</script>

<%perl>
#######################################################################################
# Show Root Blocks
#
#######################################################################################
if( $_action eq "SHOW_ROOTS" && !$id && $rootversion ){
    
    unless ( $manager && $manager->can($user, "access_section", 'ip.html:show_roots') ){
	$m->comp('/generic/error.mhtml', error => "You do not have permission to view this section");
    }

    my $get_roots = $ui->config->get('SHOW_ROOT_BLOCKS');
    if ( $get_roots ){
        @list = Ipblock->get_roots($rootversion);
        my $max = $ui->config->get('ROOT_BLOCK_SHOW_MAX');
</%perl>
       <div class="container">
          <div class="containerheadleft">Root Blocks: (<% scalar(@list) %>)</div>
          <div class="containerheadright">
	    <form name="netdotform" action="ip.html" method="POST">
	      <input type="hidden" name="_action" value="SHOW_ROOTS">
%             my $show_checked = ($show_ch_util)? 'CHECKED' : "";
              Show Utilization: <input type="checkbox" name="show_ch_util" onChange="submit();" <% $show_checked %>>
	      Version: <select name="rootversion" onChange="submit();">
%	      foreach my $version ('4', '6', 'all'){
%	        if ( $version eq $rootversion ){
		    <option value="<% $version %>" SELECTED><% $version %></option>
%		}else{
		    <option value="<% $version %>"><% $version %></option>
%		}
%	      }
              </select>
            </form>
	  </div>
          <div class="containerbody">
%             if ( @list && scalar(@list) < $max ){
                  <& ipblock_list.mhtml, parent=>0, objects=>\@list, type=>"block", show_utilization=>$show_ch_util &>
%             }else{
                  The number of root blocks exceeds the configured threshold (<% $max %>). Please use the search boxes.
%             }
          </div>
       </div>
<%perl>
    }
#######################################################################################
# Update
# 
#######################################################################################

}elsif( $_action eq "UPDATE" ){

    my $new_digest = $o->get_digest();
    eval {
	Netdot::Model->do_transaction( sub{ 
	    if ( $state_digest && ($state_digest ne $new_digest) ){
		$ui->throw_user("This IP changed while you were editing!");
	    }
	    $ui->form_to_db(%ARGS); 
				       });
    };
    if ( my $e = $@ ){
	$m->comp('/generic/error.mhtml', error=>$e);
    }else{
	# Do this to 'flush' the values associated with the object
	# before redisplaying
	$o = undef;
	if ( $id ){
	    $o = Ipblock->retrieve($id);
	}
    }

#######################################################################################
# ADD/MODIFY RANGE
#
#######################################################################################
}elsif ( $_action eq 'EDIT_RANGE'){

    unless ( $manager && $manager->can($user, "edit", $o) ){
        $m->comp('/generic/error.mhtml', error=>"You don't have permission to edit this object");
    }
    
    if ( $add_range_start && $add_range_end ){
	if ( $range_status eq 'Delete' ){
	    eval {
		Netdot::Model->do_transaction( sub{ 
		    $o->remove_range(start => $add_range_start, 
				     end   => $add_range_end);
					       });
	    };
	}else{
	    eval {
		Netdot::Model->do_transaction( sub{ 
		    $o->add_range(start       => $add_range_start, 
				  end         => $add_range_end,
				  status      => $range_status,
				  owner       => $range_owner,
				  used_by     => $range_used_by,
				  description => $range_description,
				  gen_dns     => $range_gen_dns,
				  name_prefix => $name_prefix,
				  name_suffix => $name_suffix,
				  fzone       => $range_fw_zone,
			);
					       });
	    };
	}
	if ( my $e = $@ ){
	    $m->comp('/generic/error.mhtml', error=>$e);
	}else{
	    $m->comp('.show_message', title=>"Action Message", msg=>"Address Range Modified Successfully");
	    $id = $o->id;
	}
    }else{
	$m->comp('/generic/error.mhtml', error=>"You need to specify start and end addresses");
    }

#######################################################################################
# ADD/MODIFY BLOCK
#
#######################################################################################
}elsif ( $_action eq "ADD_BLOCK" ){

    # We need the parent to determine if there are sufficient rights to add
    # a block, so if not passed, we require Admin
    my $parent;
    if ( $add_block_parent ){
	$parent = Ipblock->retrieve($add_block_parent) || 
	    $m->comp('/generic/error.mhtml', error=>"Cannot retrieve IPblock id $add_block_parent");
	unless ( $manager && $manager->can($user, 'edit', $parent) ){
	    $m->comp('/generic/error.mhtml', error=>"You don't have permission to add blocks here");
	}
    }else{
	unless ( $manager && $manager->can($user, 'access_admin_section', 'ip.html:add_block') ){
	    $m->comp('/generic/error.mhtml', error=>"You don't have permission to do this");
	}
    }
    unless ( $add_block_prefix ){
	$m->comp('/generic/error.mhtml', error=>"You need to specify IP/prefix");
    }

    $add_block_prefix =~ s/\s+//g; # Remove spaces

    if ( $submit && (($submit eq 'confirm') || ($submit eq 'Save')) ){
	undef($submit);
	my $nip = NetAddr::IP->new($add_block_prefix) ||
	    $m->comp('/generic/error.mhtml', error=>"Invalid block: $add_block_prefix");
	my ($address, $prefix) = ($nip->addr, $nip->masklen);
	if ( (($nip->version == 4 && $prefix != 32) ||
	      ($nip->version == 6 && $prefix != 128)) &&
	     ($block_status eq 'Dynamic' || $block_status eq 'Static') ){
	    $m->comp('/generic/error.mhtml', error=>"IP block cannot be 'Dynamic' or 'Static'.  Specify IP Range instead.");
	}
	my $block;
	# This has happened. Can't figure out why, but this should avoid errors
	if ( defined $block_owner && ref($block_owner) eq 'ARRAY' ){
	    $block_owner = $block_owner->[0];
	} 
	if ( defined $block_used_by && ref($block_used_by) eq 'ARRAY' ){
	    $block_used_by = $block_used_by->[0];
	} 
	eval {
	    my %args = (status      => $block_status,
			owner       => $block_owner,
			used_by     => $block_used_by,
			description => $block_description,
		);
	    if ( $block = Ipblock->search(address=>$address, prefix=>$prefix)->first ){
		if ( $add_block_parent ) {
		    $ui->throw_user("This IP has already been set to '" . $block->status->name . "', possibly by someone else.");
		}else{
		    $block->update(\%args);
		}
	    }else{
		$args{address} = $address;
		$args{prefix}  = $prefix;
		$args{parent}  = $add_block_parent if $add_block_parent;
		$block = Ipblock->insert(\%args);
	    }
	};
	if ( my $e = $@ ){
	    $m->comp('/generic/error.mhtml', error=>$e);
	}elsif ( $block ){
	    $o  = $block;
	    $id = $block->id;
	    if( $o->is_address ) {
		$added_ip  = 1;
	    }else {
		$added_block = 1;
	    }
	    if ( $o->version == 6 ){
		$view_format = 'list';
	    }
	}
    }else{
	$m->comp('/generic/confirm.html', 
		 %ARGS, 
		 target  =>'../management/ip.html', 
		 message =>'The IP address or block '.$add_block_prefix.' does not yet exist. '.
		 'Are you sure that you want to create it?',
	    );
    }

#######################################################################################
# Add multiple blocks (from partitions in container.mhtml)
# 
#######################################################################################
}elsif( $_action eq "ADD_BLOCKS" ){

    unless ( $new_blocks_list && $new_blocks_status ){
	$m->comp('/generic/error.mhtml', error=>"Missing list of blocks or desired status");
    }
    my @new_blocks = split ',', $new_blocks_list;
    eval {
	Netdot::Model->do_transaction( sub{ 
	    foreach my $b ( @new_blocks ){
		my ($addr, $pref) = split '/', $b;
		Ipblock->insert({address=>$addr, prefix=>$pref, status=>$new_blocks_status});
	    }
				       })
    };
    if ( my $e = $@ ){
	$m->comp('/generic/error.mhtml', error=>"$e");	
    }else{
	$m->comp('.show_message', title=>"Action Message", msg=>"IP blocks created successfully");
    }
	    
#######################################################################################
# ENABLE DHCP ON SUBNET
#
#######################################################################################
}elsif ( $_action eq 'ENABLE_DHCP'){
    
    unless ( $manager && $manager->can($user, 'access_admin_section', 'ip.html:enable_dhcp') ){
        $m->comp('/generic/error.mhtml', error=>"You don't have permission to enable DHCP");
    }

    unless ( $ARGS{dhcp_global_scope} ){
	$m->comp('/generic/error.mhtml', error=>"You need to specify at least the global scope");
    }
    my $container = delete $ARGS{dhcp_global_scope};
    my %args = (container=>$container);

    # Active flag
    my $active = delete $ARGS{dhcp_active};
    $args{active} = (defined $active && $active eq 'on')? 1 : 0;

    # Grab all the dhcp options & declarations
    foreach my $arg ( %ARGS ){
	if ( $arg =~ /^dhcp_/ ){
	    my $value = $ARGS{$arg};
	    if ( $arg =~ /^dhcp_(.*)$/ ){
		my $attr = $1;
		$attr =~ s/^option_/option /;
		$attr =~ s/_/-/g;
		$args{attributes}{$attr} = $value;
	    };
	}
    }
    eval {
	$o->enable_dhcp(%args);
    };
    if ( my $e = $@ ){
	$m->comp('/generic/error.mhtml', error=>$e);
    }else{
	$m->comp('.show_message', title=>"Action Message", msg=>"DHCP enabled Successfully");
    }

#######################################################################################
# Delete
#
#######################################################################################
}elsif ( $_action eq "DELETE" ){

</%perl>

%  unless ( $manager && $manager->can($user, "delete", $o) ){
%      $m->comp('/generic/error.mhtml', error=>"You don't have permission to delete this object");
%  }

  <form action="ip.html">
    <input type="hidden" name="_action" value="CONFIRM_DELETE">
    <input type="hidden" name="id" value="<% $id %>">
    
    <div class="container">
      <div class="containerhead">
        <strong>Confirm</strong>   
      </div>
      <div class="containerbody">  
        <p>Are you sure you want to delete <strong><em><% $o->get_label %></em></strong> ?
%	if ( $o->children ){
            <p>Delete children blocks <input type="checkbox" name="recursivedel">
%       }
        <p><input type="submit" name="submit" value="Yes" >
        <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
      </div>
    </div>
  </form>


<%perl>

# Do not continue with object display
  $view_object = 0;

#######################################################################################
# Confirm Delete
#
#######################################################################################
}elsif ( $_action eq "CONFIRM_DELETE" ){
  
    unless ( $manager && $manager->can($user, "delete", $o) ){
	$m->comp('/generic/error.mhtml', error=>"You don't have permission to delete this object");
    }

    my ($address, $prefix, $version) = ($o->address, $o->prefix, $o->version);
    my $parentid = $o->parent->id if ( $o->parent );
    # Remove from Database
    #
    my $rec = ($recursivedel)? 1 : 0;
    eval { $o->delete( recursive => $rec ) };
    if ( my $e = $@ ){
	$m->comp('/generic/error.mhtml', error=>$e);
    }
    
    if ($rec){
	$m->comp('.show_message', title=>"Action Message", msg=>"<p><strong>Block <em>$address/$prefix</em> and all its children blocks have been deleted</strong>");
    }else{
	$m->comp('.show_message', title=>"Action Message", msg=>"<p><strong>Block <em>$address/$prefix</em> has been deleted</strong>");
    }
    
    # Show parent block
    # after block has been deleted
    $id = $parentid;
    if ($id != 0){
	unless ( $o = Ipblock->retrieve($id) ){
	    $m->comp('/generic/error.mhtml', error => "Can't retrieve Ipblock id $id");
	}
    }

#######################################################################################
# LINK ZONES
#
#######################################################################################
}elsif ( $_action eq 'LINK_ZONES' ){
    if ( scalar @link_zones && $link_zones[0] ne "" ){
	foreach my $z ( @link_zones ){
	    eval {
		SubnetZone->insert({subnet=>$o, zone=>$z});
	    };
	    if ( my $e = $@ ){
		$m->comp('/generic/error.mhtml', error=>"Problem linking zones to this subnet: $e");
	    }else{
		$m->comp('.show_message', title=>"Action Message", msg=>"<p><strong>Zone(s) linked successfully</strong>");
	    }
	}
    }else{
	$m->comp('/generic/error.mhtml', error=>"Please select one or more zones to link to this subnet");
    }

#######################################################################################
# ADD_REV_ZONE
#
#######################################################################################
}elsif ( $_action eq 'ADD_REV_ZONE' ){
    if ( @new_rev_zones && ($new_rev_zones[0] ne "") ){
	eval {
	    Netdot::Model->do_transaction(sub{ 
		foreach my $name ( @new_rev_zones ){
		    my %args = (name=>$name);
		    $args{template} = $template_zone_for_rev if ( $template_zone_for_rev );
		    my $z = Zone->insert(\%args);
		}
					  });
	};
	if ( my $e = $@ ){
	    $m->comp('/generic/error.mhtml', error=>"Problem creating new reverse zones: $e");
	}else{
	    $m->comp('.show_message', title=>"Action Message", msg=>"<p><strong>Reverse zone(s) created successfully</strong>");
	}
    }else{
	$m->comp('/generic/error.mhtml', error=>"Please provide a name for at least one reverse zone");
    }

#######################################################################################
# ADD_A_RECORD
#
#######################################################################################
}elsif ( $_action eq 'ADD_A_RECORD' ){

    unless ( $manager && $manager->can($user, "edit", $o) ){
        $m->comp('/generic/error.mhtml', error=>"You don't have permission to edit this object");
    }

    unless ( $new_a_name && $new_a_zone ){
	$m->comp('/generic/error.mhtml', error=>"Adding a DNS record requires both a name and a zone");
    }
    eval {
	RR->insert({type=>"A", name=>$new_a_name, zone=>$new_a_zone, ipblock=>$o});
    };
    if ( my $e = $@ ){
	$m->comp('/generic/error.mhtml', error=>$e);
    }else{
	$m->comp('.show_message', title=>"Action Message", msg=>"$dns_address_record_label record added successfully");
    }
    
    

#######################################################################################
# REBUILD_TREE
#
#######################################################################################
}elsif ( $_action eq 'REBUILD_TREE' ){

    if ( $tree_version eq '4' || $tree_version eq 'all' ){
	Ipblock->build_tree(4);
    }    
    if ( $tree_version eq '6' || $tree_version eq 'all' ){
	Ipblock->build_tree(6);
    }
    $m->comp('.show_message', title=>"Action Message", msg=>"IP Tree Rebuilt Successfully");
}
#######################################################################################
# View
#
#######################################################################################

if ( $id && $view_object ){
    if ( $edit ){	 
</%perl>

    <form name="netdotform" action="ip.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="view" value="<% $view %>">

%   my $digest = $o->get_digest();
    <input type="hidden" name="state_digest" value="<% $digest %>">

%      if ( $edit_ip || $edit_block || $edit_comments ){
	 <input type="hidden" name="_action" value="UPDATE">
%      }

%    }

<%perl>
my @line;
if ( my @parents = $o->get_ancestors ){
    foreach my $par ( reverse @parents ){
    	push (@line, "<a href=\"ip.html?id=" . $par->id . "\">" . $par->get_label . "</a>");
    }
    push (@line, '<strong>'.$o->get_label.'</strong>');  
}    
 
</%perl>

 <div class="containeroutside">

    <div class="containerheadleftoutside">
      <a href="ip.html?_action=SHOW_ROOTS&rootversion=all">[*]</a>: 
%     if ( @line ){
%        print join ' : ', @line;
%     }else{
         <strong><% $o->get_label %></strong>
%     }
    </div>

% if ( $o->is_address ){

%#######################################################################################
%# View IP address
%#######################################################################################


    <div class="containerheadrightoutside">
%	 if ($edit eq "ipinfo"){	 
%            if ($added_ip) {
    	         <input type="submit" name="submit" value="cancel">
%                my @parents = $o->get_ancestors;
                 <input type="hidden" name="parent" value="<% $parents[0] %>">
%            } else {
    	         <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
%            }
             <input type="submit" name="submit" value="save">
%	 }else{
            <a href="ip.html?id=<% $id %>">[refresh]</a>
%           if ( $manager && $manager->can($user, 'access_section', 'ip.html:edit_ipinfo') ){
%               if ( $manager && $manager->can($user, 'edit', $o) ){
                    <a href="ip.html?id=<% $id %>&edit=ipinfo">[edit]</a>
%               }
%               if ( $manager && $manager->can($user, 'delete', $o) ){
                    <a href="ip.html?id=<% $id %>&_action=DELETE">[delete]</a>
%               }
%           }
%	 }
    </div>

    <div class="containerbodyoutside">

<%perl>
       my @field_headers;
       my @cell_data;

################################################################
# Address
       my %addr_tmp = $ui->form_field(object=>$o, column=>"address", edit=>$edit_ip, 
				      htmlExtra=>"style='width: 15em'");
       push( @field_headers, $addr_tmp{'label'} );
       push( @cell_data, $addr_tmp{'value'} );

       push( @field_headers, $ui->col_descr_link('Ipblock', 'status', 'Status: ')  );

       my $status;
       my @valid_block_status = qw ( Static Dynamic Reserved );
       if ( my $sn = $o->status->name ){
           if ( $edit eq "ipinfo" ){
              $status = qq(<select name="Ipblock__).$o->id.qq(__status">);
              foreach my $st ( @valid_block_status ){
                 if ( $st eq $sn ){
                    $status .= qq(<option value="$st" SELECTED>$st</option>);
                 }else{
                    $status .= qq(<option value="$st">$st</option>);
                 }
              }
              $status .= "</select>";
           }else{
              $status = qq(<strong>$sn</strong>);
           }
       }

       push( @cell_data, $status );

       my @fields = ('description', 'first_seen', 'last_seen', 'owner', 'used_by', 'monitored');
       $ui->add_to_fields(o=>$o, edit=>$edit_ip, fields=>\@fields, field_headers=>\@field_headers, cell_data=>\@cell_data);

       push( @field_headers, "Interface:" );
       push( @cell_data, 
	     $ui->select_lookup(object=>$o, table=>"Ipblock", column=>'interface', lookup=>"Interface",
				edit=>$edit_ip, returnAsVar=>1, linkPage=>1)
	     );
    push( @field_headers, "Device:" );
    push( @cell_data, 
        eval {
	    my $device;
	    $device = $o->interface->device if ($o->interface);
	    $device ||= ($o->snmp_devices)[0];
            if ( $device ){
                qq(<a href="device.html?id=).$device->id.qq(">).$device->get_label()."</a>";
            }else{
                "&nbsp;";
            }
        }  );
</%perl>

%# actually output the table to the browser
<& /generic/attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data,
                          width=>"2", headercolwidth=>"15%", datacolwidth=>"35%" &>

    </div>

%################################################################
%# Comments section
<div class="container">
    <div class="containerheadleft">
        Comments
    </div>
    <div class="containerheadright">
%	if ( $edit eq 'comments' ){
            <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
            <input type="submit" name="submit" value="save">
%	}else{
%           if ( $manager && $manager->can($user, "edit", $o) ){
                <a href="ip.html?id=<% $id %>&edit=comments">[edit]</a>
%           }else{
                &nbsp;
%	    }
%	}
     </div>
 <div class="containerbody">
<%perl>
my $edit_comments = ($edit eq 'comments') ? 1 : 0;
my %tmp;
%tmp = $ui->form_field(object=>$o, column=>"info", edit=>$edit_comments);
print $tmp{value};         
</%perl>

    </div>
 </div>

%################################################################
<%perl>
if (!$edit){
    print '<div class="container">';
    print '<div class="containerheadleft">DNS '.$dns_address_record_label.' Records</div>';
    print '<div class="containerheadright">';
    if ( ($_action ne 'VIEW_ADD_A_RECORD') && $manager && $manager->can($user, 'edit', $o) ){
	print "<a href=\"ip.html?id=$o&_action=VIEW_ADD_A_RECORD\">[add]</a>";
    }else{
	print '&nbsp;';
    }
    print '</div>';
    print '<div class="containerbody">';
    if ( $_action eq 'VIEW_ADD_A_RECORD' ){
	my $zone = $o->forward_zone();
	# Make sure that user does not add a record to a zone for which
	# they don't have permissions
	my @zone_list;
	if ( $zone ){
	    @zone_list = ( $zone );
	}
	foreach my $z ( sort { $a->name cmp $b->name } Zone->retrieve_all ){
	    next if $z->is_dot_arpa;
	    next unless $z->active;
	    next if $zone && ($z->id == $zone->id);
	    if ( $manager && $manager->can($user, 'edit', $z) ){
		push @zone_list, $z;
	    }
	}

</%perl>
      <div class="containerbody">
	  <form name="netdotform" action="ip.html" method="POST">
	    <input type="hidden" name="id" value="<% $o->id %>">
	    <input type="hidden" name="_action" value="ADD_A_RECORD">
            Name: <input type="text" name="new_a_name" value="">
	    <select name="new_a_zone">
            <option value=""> - select - </option>
%	    foreach my $zone ( @zone_list ){
                <option value="<% $zone->id %>"><% $zone->get_label %></option>
%	    }
            </select>
            <p><input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
            <input type="submit" name="submit" value="add">
	  </form>
<%perl>	  
    }else{
        my @rraddrs = $o->a_records();
        my @rrs = map { $_->rr } @rraddrs;
	$m->comp('/generic/sortresults.mhtml', object=>\@rrs);
    }
    print '</div>';
    print '</div>';

    my @ptrs = $o->ptr_records();
    my @prrs = map { $_->rr } @ptrs;
    print '<div class="container">';
    print '<div class="containerheadleft">DNS PTR Records</div>';
    print '<div class="containerheadright">';
    if ( $manager && $manager->can($user, 'edit', $o) ){
	print "<a href=\"edit.html?table=RRPTR&ipblock=$o\">[add]</a>";
    }else{
	print '&nbsp;';
    }    
    print '</div>';
    print '<div class="containerbody">';
    $m->comp('/generic/sortresults.mhtml', object=>\@prrs);
    print '</div>';
    print '</div>';
}

# Do not show DHCP scope unless the subnet has DHCP enabled
if ($o->parent && $o->parent->dhcp_scopes) {
    my $gscope = $o->parent->dhcp_scopes->first->container;
    my @scopes  = $o->dhcp_scopes;
    
    print '<div class="container">';
    print '<div class="containerheadleft"><b>DHCP Host</b></div>';
    print '<div class="containerheadright">';
    if ( @scopes ){
	print '&nbsp;';
    }else{
	# Let user add a scope
	print '&nbsp;';
	if ( $_action ne 'VIEW_ADD_DHCP' && $manager && $manager->can($user, 'edit', $o) ){
	    print '<a href="ip.html?id='.$o.'&_action=VIEW_ADD_DHCP">[add]</a>';
	}
    }
    print '</div>';
    print '<div class="containerbody">';
    if ( $_action eq 'VIEW_ADD_DHCP' ){
	print '<form name="netdotform" action="ip.html" method="POST">';
	printf('<input type="hidden" name="id" value="%d">', $o->id);
	print '<input type="hidden" name="_action" value="UPDATE">';

	my (@field_headers, @cell_data) = ((),());
	# User wants to add a scope with this ip
	printf('<input name="DhcpScope__NEW__container" value="%s" type="hidden">', $gscope);
	printf('<input name="DhcpScope__NEW__type" value="host" type="hidden">');
	printf('<input name="DhcpScope__NEW__name" value="%s" type="hidden">', $o->address);
	printf('<input name="DhcpScope__NEW__ipblock" value="%s" type="hidden">', $o->id);
	if ( $o->version == 4 || 
	     ($o->version == 6 && 
	      Netdot->config->get('DHCPD_ALLOW_ETHERNET_FOR_IPV6_HOST_DECL')) ){
	    push @field_headers, ('Ethernet: ');
	    push( @cell_data, '<input name="DhcpScope__NEW__physaddr" value="" type="text">' );
	}elsif ( $o->version == 6 ){
	    push @field_headers, ('DUID: ');
	    push( @cell_data, '<input name="DhcpScope__NEW__duid" value="" type="text" size="48">' );
	}
	$m->comp('/generic/attribute_table.mhtml', field_headers=>\@field_headers,
		 data=>\@cell_data, width=>1);
	print '<p><input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">';
        print '<input type="submit" name="submit" value="add">';
	print '</form>';
    }else{
	$m->comp('/generic/sortresults.mhtml', object=>\@scopes);
    }
    print '</div>'; #close containerbody of DHCP
    print '</div>'; #close container of DHCP
}

if ( $edit ){
    print '</form>';
}

</%perl>
% if ( $manager && $manager->can($user, "access_section", 'ip.html:edit_ipinfo') ){


%################################################################
<div class="container">
    <div class="containerheadleft">Services</div>
    <div class="containerheadright">
%   if ( $manager && $manager->can($user, 'edit', $o) ){
	<a href="edit.html?table=IpService&ip=<% $o %>">[add]</a>
%   }else{
        &nbsp;
%   }
    </div>
<%perl>
    my @headers = ("Service", "Contact List");
    my @rows = ();
    foreach my $ipservice ($o->services){
	push( @rows,
	      [ eval {
		  if ($edit eq "ipinfo"){	 
		      $ui->form_field(object=>$ipservice, column=>"service", edit=>$edit_ip, returnValOnly=>1);
		  }else{
		      qq(<a href="view.html?table=Service&id=).$ipservice->service->id.qq(">).$ipservice->service->name."</td></a>";
		  }
	      } ,
		eval {
                    if ($edit eq "ipinfo"){
                        $ui->form_field(object=>$ipservice, column=>"contactlist", edit=>$edit_ip, returnValOnly=>1);
                    }elsif ($o->used_by){
                        qq(<a href="view.html?table=ContactList&id=).$ipservice->contactlist.qq(">).$ipservice->contactlist->name."</td></a>";
                    }
		}
                ]  );
    } 
    $m->comp('/generic/data_table.mhtml', field_headers=>\@headers, data=>\@rows ) if ( $o->services ); 
</%perl>
</div>

% }

%################################################################
<!-- Display Custom Attributes -->
% my @attributes = $o->attributes;
  <div class="container">
    <div class="containerheadleft"><strong>Custom Attributes</strong></div>
    <div class="containerheadright">
%     if ( @attributes ) {
        <a href="ip.html?id=<% $o %>&view=Attributes&editattr=1">[edit]</a>
%     }
%   if ( $manager && $manager->can($user, 'edit', $o) ){
        <a href="edit.html?table=IpblockAttr&ipblock=<% $o %>">[add]</a>
%   }else{
        &nbsp;
%   }
    </div>
    <div class="containerbody">
        <& /generic/sortresults.mhtml, object=>\@attributes, withedit=>$editattr, return_args=>"?id=$id" &>
    </div>
  </div>
<!-- End Display Custom Attributes -->

%################################################################
<!-- Display ARP -->
<%perl>
# Get latest arp entries
    if ( my $arp = $o->get_last_n_arp($arp_limit) ){
        my @rows;
	my %tstamps;
        foreach my $row ( @$arp ){
            my ($iid, $macid, $tstamp) = @$row;
            my $lbl    = Interface->retrieve($iid)->get_label;
            my $lnk   = "<a href=\"interface.html?id=$iid\">$lbl</a>";
	    push @{$tstamps{$tstamp}{$macid}}, $lnk;
        }
	foreach my $tstamp ( reverse sort keys %tstamps ){
	    foreach my $macid ( keys %{$tstamps{$tstamp}} ){
		my $maclbl   = PhysAddr->retrieve($macid)->get_label;
		my $maclnk   = "<a href=\"../management/mac.html?id=$macid\">$maclbl</a>";
		push @rows, [$tstamp, $maclnk, (join ', ', @{$tstamps{$tstamp}{$macid}})];
	    }
	}
       
</%perl>
<div class="container">
    <div class="containerheadleft"><strong>Last <% $arp_limit %> ARP entries</strong></div>
          <div class="containerheadright">
	    <form name="netdotform" action="ip.html" method="POST">
	      <input type="hidden" name="id" value="<% $id %>">
	      Last <input type="text" size="3" name="arp_limit" value="<% $arp_limit %>"> ARP entries <input type="submit" name="submit" value="show">
            </form>
	  </div>
    <div class="containerbodyoutside">
        <& /generic/data_table.mhtml, field_headers=>['Time Seen', 'MAC', 'Interfaces'], data=>\@rows, style=>['', '', 'width: 60%'] &>
    </div>
</div>

%     }
<!-- End Display ARP -->

%################################################################
% my @audit = $o->get_audit_records;
% if ( @audit ){
<!-- Display Audit Records -->
  <div class="container">
    <div class="containerheadleft"><strong>Audit Records</strong></div>
    <div class="containerheadright">&nbsp;</div>
    <div class="containerbody">
        <& /generic/sortresults.mhtml, object=>\@audit, view=>"row" &>
    </div>
  </div>
<!-- End Display Audit Records -->
% }
</div>

%} else {     
%#######################################################################################
%# View Block
%#######################################################################################

    <div class="containerheadrightoutside">
%  if ( $edit eq "blockinfo" || $edit eq 'address_range' || $edit eq 'enable_dhcp' ){
%        if ( $added_block ) {
    	    <input type="submit" name="submit" value="cancel">
%           my @parents = $o->get_ancestors;
            <input type="hidden" name="parent" value="<% $parents[0] %>">
%        } else {
    	    <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
%        }
         <input type="submit" name="submit" value="save">

%  }else{
    <a href="ip.html?id=<% $id %>&view=<% $view %>">[refresh]</a>
%      if ( $manager && $manager->can($user, "access_section", 'ip.html:edit_blockinfo') ){
%           if ( $manager && $manager->can($user, 'access_admin_section', 'ip.html:edit_block') ){
	        <a href="ip.html?id=<% $id %>&edit=blockinfo">[edit]</a>
%           }
%	    if ( $o->status->name eq 'Subnet' ){
%               if ( $manager && $manager->can($user, 'edit', $o) ){
	            <a href="ip.html?id=<% $id %>&view=Children&edit=address_range">[range]</a>
%               }
%           }
%           if ( $manager && $manager->can($user, 'access_admin_section', 'ip.html:delete_block') ){
	        <a href="ip.html?id=<% $id %>&_action=DELETE">[delete]</a>
%           }
%       }
%  }
    </div>

%#######################################################################
%# Navigation Bar
%#######################################################################

% if ( $manager && $manager->can($user, "access_section", 'ip.html:sites') ){
    <div id="navbar">
        <ul id="navigation">
%         if( $view eq "Children" ) {
              <li><span>Children</span></li>
%         } else {
              <li><a href="ip.html?id=<% $id %>&view=Children">Children</a></li>
%         }
%         if( $view eq "Sites" ) {
              <li><span>Sites</span></li>
%         } else {
              <li><a href="ip.html?id=<% $id %>&view=Sites">Sites</a></li>
%         }
%         if( $view eq "Zones" ) {
              <li><span>Zones</span></li>
%         } else {
              <li><a href="ip.html?id=<% $id %>&view=Zones">Zones</a></li>
%         }
%         if ( $o->status->name eq 'Subnet' ){
%             if( $view eq "DHCP" ) {
                  <li><span>DHCP</span></li>
%             } else {
                  <li><a href="ip.html?id=<% $id %>&view=DHCP">DHCP</a></li>
%             }
%         }
%         if( $view eq "Rights" ) {
              <li><span>Access Rights</span></li>
%         } else {
            <li><a href="ip.html?id=<% $id %>&view=Rights">Access Rights</a></li>
%         }
%         if( $view eq "Attributes" ) {
              <li><span>Attributes</span></li>
%         } else {
            <li><a href="ip.html?id=<% $id %>&view=Attributes">Attributes</a></li>
%         }
%         if( $view eq "Comments" ) {
              <li><span>Comments</span></li>
%         } else {
              <li><a href="ip.html?id=<% $id %>&view=Comments">Comments</a></li>
%         }
%         if( $view eq "Audit" ) {
              <li><span>Audit</span></li>
%         } else {
              <li><a href="ip.html?id=<% $id %>&view=Audit">Audit</a></li>
%         }
%         if( $view eq "All" ) {
              <li><span>All</span></li>
%         } else {
            <li><a href="ip.html?id=<% $id %>&view=All">All</a></li>
%         }
        </ul>
    </div>
% }

%#######################################################################
%# Body
%#######################################################################

    <div class="containerbody">

% if ( $edit eq 'address_range' ){

%     unless ( $manager && $manager->can($user, 'edit', $o) ){
%          $m->comp('/generic/error.mhtml', error=>"You don't have permission to edit this object");
%     }

    <p><b>Add/Modify Address Range</b>
    <input type="hidden" name="_action" value="EDIT_RANGE">

<%perl>	
    my @fields;
    my @data;     
    push @fields,'IP Range:';
    if ( $o->version == 4 ){
        push @data, '<input type="text" name="add_range_start" class="txt" value="'.$o->netaddr->first->addr.
	    '"> - <input type="text" name="add_range_end" class="txt" value="'.$o->netaddr->last->addr.'">';
    }elsif ( $o->version == 6 ){
	push @data, '<input type="text" name="add_range_start" class="longtxt" value="'.$o->netaddr->addr.
	    '"> - <input type="text" name="add_range_end" class="longtxt" value="'.$o->netaddr->broadcast->addr.'">';
    }
    
    push @fields, 'Status:';
    push (@data, &{sub{ 
	my $x;
	$x .= '<select name="range_status" id="range_used_by">';
        $x .= '<option value="">-- Select --</option>';
	my @allstatus = qw( Dynamic Reserved Static Delete ); 
	foreach my $status ( @allstatus ){
	    $x .= '<option value="'.$status.'">'.$status.'</option>';
	}
	$x .= '</select>';
	$x;
    }});

    my @allents = sort { $a->name cmp $b->name } Entity->retrieve_all; 

    push @fields, 'Owner:';
    push (@data, &{sub{
	my $x;
	$x .= '<select name="range_owner" id="range_owner">';
	$x .= '<option value="">-- Select --</option>';
	foreach my $ent ( @allents ){
	    $x .= '<option value="'. $ent->id .'">'. $ent->name .'</option>';
	}
	$x .= '</select>';
	$x .= '<a class="hand" onClick="openinsertwindow(\'table=Entity&select_id=range_owner&selected=1&dowindow=1\')">[new]</a>';
	$x;
    }});

    push @fields, 'Used By:';
    push (@data, &{sub{
	my $x;
	$x .= '<select name="range_used_by" id="range_used_by">';
	$x .= '<option value="">-- Select --</option>';
	foreach my $ent ( @allents ){
	    $x .= '<option value="'. $ent->id .'">'. $ent->name .'</option>';
	}
	$x .= '</select>';
	$x .= '<a class="hand" onClick="openinsertwindow(\'table=Entity&select_id=range_used_by&selected=1&dowindow=1\')">[new]</a>';
	$x;
    }});

    push @fields, 'Description:';
    push @data, '<input type="text" class="longtxt" name="range_description">';

    push @fields, 'Auto-generate DNS records:';
    push @data, '<input type="checkbox" name="range_gen_dns" checked="checked">';

    push @fields, 'DNS name prefix/suffix:';
    push @data, '<input type="text" size="5" name="name_prefix" value="'.Netdot->config->get("IP_RANGE_DNS_DEFAULT_PREFIX").'"> <input type="text" size="5" name="name_suffix" value="'.Netdot->config->get("IP_RANGE_DNS_DEFAULT_SUFFIX").'">';

    my $fwzone   = $o->forward_zone();
    my $revzone  = $o->reverse_zone();
    my @allzones = Zone->retrieve_all();

    push @fields, 'Forward Zone';
    push (@data, &{sub{
	my $x;
	$x .= '<select name="range_fw_zone" id="range_fw_zone">';
	$x .= '<option value="">-- Select --</option>';
	if ( $fwzone ){
	    $x .= '<option value="'. $fwzone->id .'" SELECTED>'. $fwzone->name .'</option>';
	}
	foreach my $z ( @allzones ){
	    next unless defined $z;
	    next if ( $z->name =~ /\.arpa$|\.int$/ );
	    $x .= '<option value="'. $z->id .'">'. $z->name .'</option>';
	}
	$x .= '</select>';
	$x .= '<a class="hand" onClick="openinsertwindow(\'table=Zone&select_id=range_fw_zone&selected=1&dowindow=1\')">[new]</a>';
	$x;
    }});

</%perl>

<& /generic/attribute_table.mhtml, field_headers=>\@fields, data=>\@data,
	                            width=>"2", headercolwidth=>"15%", datacolwidth=>"35%" &>



% }elsif ( $edit eq 'enable_dhcp' ){

    <p><b>Create a DHCP Scope for this subnet</b>
    <input type="hidden" name="_action" value="ENABLE_DHCP">

<%perl>

    my @fields;
    my @data;     

    push @fields,'Global Scope:';
    push (@data, &{sub{
	my $x;
	$x .= '<select name="dhcp_global_scope" id="dhcp_global_scope">';
	$x .= '<option value="">-- Select --</option>';
	foreach my $ent ( DhcpScope->search(type=>'global', version=>$o->version) ){
	    $x .= '<option value="'. $ent->id .'">'. $ent->name .'</option>';
	}
	$x .= '</select>';
	$x .= '<a class="hand" onClick="openinsertwindow(\'table=DhcpScope&select_id='.
	    'dhcp_global_scope&selected=1&dowindow=1\')">[new]</a>';
	$x;
    }});

    push @fields, "&nbsp;";
    push @data,   "&nbsp;";
    push @fields, "Subnet:";
    push @data,   $o->get_label();
    unless ( $o->version == 6 ){
	push @fields, 'Option routers:';
	push @data,   '<input type="text" name="dhcp_option_routers" class="txt" value="'.$o->netaddr->first->addr.'">';
    }
    push @fields, 'Active?:';
    push @data, '<input type="checkbox" name="dhcp_active" checked="checked"> (Uncheck if you do not want this scope'.
	' included in the DHCP configuration)';

    
</%perl>	

<& /generic/attribute_table.mhtml, field_headers=>\@fields, data=>\@data,
	                            width=>"1", headercolwidth=>"15%", datacolwidth=>"35%" &>

    
<%perl>

 }else{

my @field_headers = ( );
my @cell_data = ( );

################
# Address:
my %addr_tmp = $ui->form_field(object=>$o, column=>"address", edit=>$edit_block, htmlExtra=>"style='width: 15em'");
my %pref_tmp = $ui->form_field(object=>$o, column=>"prefix", edit=>$edit_block, htmlExtra =>"style='width: 3em'");
push( @field_headers, $addr_tmp{'label'} );
push( @cell_data, $addr_tmp{'value'}."/".$pref_tmp{'value'} );

################
# Status:
push( @field_headers, $ui->col_descr_link('Ipblock', 'status', 'Status: ') );
my $status;
my @valid_block_status = qw ( Container Subnet Reserved );
if ( my $sn = $o->status->name ){
    if ( $edit eq "blockinfo" ){
	$status .= "<select name=\"Ipblock__".$o->id."__status\">";
	foreach my $st ( @valid_block_status ){
	    if ( $st eq $sn ){
		$status .= "<option value=\"".$st."\" SELECTED>".$st."</option>";
	    }else{
		$status .= "<option value=\"".$st."\">".$st."</option>";
	    }
	}
	$status .= "</select>";
    }else{
	$status .= "<strong>".$sn."</strong>";
    }
}
push( @cell_data, $status );

################
# Description
$ui->add_to_fields(o=>$o, edit=>$edit_block, fields=>['description'], field_headers=>\@field_headers, cell_data=>\@cell_data);

 ################
# Use Network Broadcast
if ( $o->status->name eq 'Subnet' ){
    $ui->add_to_fields(o=>$o, edit=>$edit_block, fields=>['use_network_broadcast'], field_headers=>\@field_headers, cell_data=>\@cell_data);
}


################
# Created, Modified
push (@field_headers, "First Seen", "Last Seen");
my %createdtmp = $ui->form_field(object=>$o, column=>'first_seen', edit=>0);
my %modtmp     = $ui->form_field(object=>$o, column=>'last_seen',  edit=>0);
push( @cell_data, $createdtmp{'value'}, $modtmp{'value'} );

################
# Vlan
if ( $o->status->name eq 'Subnet' ){
    my %tmp = $ui->form_field(object=>$o, column=>'vlan', edit=>$edit_block, linkPage=>'view.html');
    push( @field_headers, $tmp{'label'} );
    push( @cell_data, $tmp{'value'} );
# }else{
#     push( @field_headers, '&nbsp;');
#     push( @cell_data, '&nbsp;');
}

################
# RIR and ASN
if ( $o->status->name eq 'Container' ){
    
    my $defaults = Netdot->config->get('VALID_RIRS');
    $ui->add_to_fields(o=>$o, edit=>$edit_block, fields=>['rir'], 
		       field_headers=>\@field_headers, cell_data=>\@cell_data, defaults=>[$defaults]);

    $ui->add_to_fields(o=>$o, edit=>$edit_block, fields=>['asn'], 
		       field_headers=>\@field_headers, cell_data=>\@cell_data, linkpages=>['view.html']);
}

################
# Owner
# For some fields, we will provide a way to update the values recursively in all 
# descendant blocks.
my %owner_tmp = $ui->form_field(object=>$o, column=>"owner", edit=>0, linkPage=>"view.html");
my $owner = $owner_tmp{value};

if ( ! $edit_block ){
    if ( $manager && $manager->can($user, 'access_admin_section', 'ip.html:edit_owner') ){
	$owner .= '<a href="#" onClick="edit_recursive(' . $o->id . ',\'owner\', \'0\')">[edit]</a>';
    }
}
push( @field_headers, $owner_tmp{label} );
push( @cell_data, $owner );

################
# Used by    
my %used_by_tmp = $ui->form_field(object=>$o, column=>"used_by", edit=>0, linkPage=>"view.html");
my $used_by = $used_by_tmp{value};
if ( ! $edit_block ){
    if ( $manager && $manager->can($user, 'access_admin_section', 'ip.html:edit_used_by') ){
	$used_by .= '<a href="#" onClick="edit_recursive(' . $o->id . ',\'used_by\', \'0\')">[edit]</a>';
    }
}

push( @field_headers, $used_by_tmp{'label'} );
push( @cell_data, $used_by );


################
# Netmask/broadcast
my $ip = new NetAddr::IP($o->address, $o->prefix);

push( @field_headers, "Netmask:", "Broadcast:" );
push( @cell_data, ($ip->version == 4 ? $ip->mask : '/'.$o->prefix) );
push( @cell_data, ($ip->version == 4 ? $ip->broadcast->addr : "n/a") );

################
# Usable address range

push( @field_headers, "Usable Addresses:" );
my ($num_addresses, $first_address, $last_address);
if ( $o->version == 4 ){
    if ( $o->prefix == 31 ){
	$num_addresses = 2;
	$first_address = $ip->addr;
	$last_address  = $ip->broadcast->addr;
    }else{
	$num_addresses = $o->num_addr;
	$first_address = $ip->first->addr;
	$last_address  = $ip->last->addr;
    }
}else{
    $num_addresses = $o->num_addr;
    $first_address = $ip->network->canon;
    $last_address  = $ip->broadcast->canon;
}
push( @cell_data, ($num_addresses." (". $first_address." - ".$last_address.")") );
	
if ($o->status->name eq "Subnet") {
      my $used  = new Math::BigInt($o->address_usage);
      my $total = $o->num_addr;
      my $avail = $total - $used;
      my $avail_percent = $ui->friendly_percent(value=>$avail,total=>$total);
      my $used_percent  = $ui->friendly_percent(value=>$used,total=>$total);
      my $percent = ($used*100)/$total;

    my $available_text;
    {
        my $used_text;
        if ($used <= $max_ips) {
            $used_text = 'Used: '.$used;
            if ($total <= $max_ips) {
                $used_text .= ' of '.$total;
            }
            $used_text .= ' &nbsp;&nbsp;';
        }
        my $avail_text = 'Available: ';
        if ($avail <= $max_ips) {
            $avail_text .= $avail.' &nbsp;(';
        }
        $avail_text .= $ui->friendly_percent(value=>$avail,total=>$total);
        if ($avail <= $max_ips) {
            $avail_text .= ')';
        }
        $available_text = $used_text.$avail_text;
    }

################
# Utilization
    push( @field_headers, "Utilization:" );
    push( @cell_data, ($ui->percent_bar(percent=>$percent))
        .'<div class="small">'.$available_text.'</div>' );

} elsif( $o->status->name eq "Container" ) {
      my $total = new Math::BigInt($o->num_addr);

      my $used_a = new Math::BigInt($o->address_usage);
      my $avail_a = $total - $used_a;
      my $used_s = new Math::BigInt($o->subnet_usage);
      my $avail_s = $total - $used_s;

      my $address_percent = $used_a*100/$total;
      my $subnet_percent = $used_s*100/$total;

    my $address_text;
    my $subnet_text;

    $subnet_text = 'Available: '.($ui->friendly_percent(value=>$avail_s,total=>$total));

        if( $used_a <= $max_ips ) {
            $address_text .= 'Used: '.$used_a;
            if( $total <= $max_ips ) {
                $address_text .= ' of '.$total;
            }
            $address_text .= ' &nbsp;&nbsp; Available: ';
            if( $total <= $max_ips ) {
                $address_text .= $avail_a.' &nbsp;(';
            }
            $address_text .= $ui->friendly_percent(value=>$avail_a,total=>$total);
            if ($total <= $max_ips) {
                $address_text .= ')';
            }
        } else {
            if( $avail_a <= $max_ips ) {
                $address_text .= 'Available: '.$avail_a.' ('.(100-$address_percent).'%)';
            } else {
                $address_text .= 'Available: '.(100-$address_percent).'%';
            }
        }

################
# Address Utilization
    push( @field_headers, "Address Utilization:" );
    push( @cell_data, $ui->percent_bar(percent=>$address_percent).'<div class="small">'.$address_text.'</div>' );

################
# Space allocated
    push( @field_headers, "Space Allocated:" );
    push( @cell_data, $ui->percent_bar(percent=>$subnet_percent).'<div class="small">'.$subnet_text.'</div>' );

}

</%perl>

%# actually output the table to the browser
<& /generic/attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data,
	                            width=>"2", headercolwidth=>"15%", datacolwidth=>"35%" &>

% }

%     if ( $edit ){	 
         </form>
%     }


%################################################################
%# Comments
%################################################################
% if ( $view eq 'Comments' || $view eq 'All' ){
<div class="container">
    <div class="containerheadleft">
        Comments
    </div>
    <div class="containerheadright">
%	if ( $edit eq 'comments' ){
            <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
            <input type="submit" name="submit" value="save">
%	}else{
%           if ( $manager && $manager->can($user, "edit", $o) ){
                <a href="ip.html?id=<% $id %>&view=Comments&edit=comments">[edit]</a>
%           }else{
                &nbsp;
%	    }
%	}
     </div>
 <div class="containerbody">
<%perl>
my $edit_comments = ($edit eq 'comments') ? 1 : 0;
my %tmp;
%tmp = $ui->form_field(object=>$o, column=>"info", edit=>$edit_comments);
print $tmp{value};         
</%perl>

    </div>
</div>
% }

%################################################################
%# Audit records
%################################################################
% if ( $view eq 'Audit' || $view eq 'All' ){
%    my @audit = $o->get_audit_records();
<div class="container">
    <div class="containerheadleft">
        Audit
    </div>
    <div class="containerheadright">&nbsp</div>
 <div class="containerbody">
    <& /generic/sortresults.mhtml, object => \@audit , view => "row" &>
 </div>
</div>
% }


%################################################################
%# DHCP Scopes
%################################################################
% if ( $view eq 'DHCP' || $view eq 'All' ){
    <div class="container">
      <div class="containerheadleft">DHCP Scope</div>
%   if ( my @scopes = $o->dhcp_scopes ){
      <div class="containerheadright">&nbsp;</div>
      <div class="containerbody">
         <& /generic/sortresults.mhtml, object=>\@scopes &>
      </div>
%   }else{
        <div class="containerheadright">
%       if ( !($edit eq 'enable_dhcp') && 
%	     $manager && $manager->can($user, 'access_admin_section', 'ip.html:enable_dhcp') ){
           <a href="ip.html?id=<% $id %>&view=DHCP&edit=enable_dhcp">[enable]</a>
%       }else{
            &nbsp;
%       }
        </div>
%   }
    </div>
% }

% if ( $view eq 'Sites' || $view eq 'All'){

%################################################################
%# Sites
%################################################################
% if ( $manager && $manager->can($user, "access_section", 'ip.html:sites') ){
% my @ss = $o->sites;
  <div class="container">
    <div class="containerheadleft">Sites</div>
       <div class="containerheadright">
       &nbsp;
%      if ( $edit ne 'edit_sites' ){
%          if ( $manager && $manager->can($user, 'edit', $o) ){
%              if ( @ss ){
                   <a href="ip.html?id=<% $o %>&view=Sites&edit=edit_sites">[edit]</a>
%              }
               <a href="edit.html?table=SiteSubnet&subnet=<% $o %>">[add]</a>
%          }
%      }
       </div>
    <div class="containerbody">
       <& /generic/sortresults.mhtml, object=>\@ss, return_args=>"?id=$id&view=$view", withedit=>($edit eq 'edit_sites')? 1 : 0  &>
    </div>
  </div>

%  }
% }

% if ( $view eq 'Zones' || $view eq 'All' ){

%################################################################
%# Forward Zones
%################################################################
% if ( $manager && $manager->can($user, "access_section", 'ip.html:edit_fzones') ){

%     my @sz = $o->zones;
      <div class="container">
      <div class="containerheadleft">Forward DNS Zones</div>
      <div class="containerheadright">
      &nbsp;
%     if ( $edit ne 'edit_fzones' ){
%         if ( $manager && $manager->can($user, 'edit', $o) ){
%             if ( @sz ){
                  <a href="ip.html?id=<% $o %>&view=Zones&edit=edit_fzones">[edit]</a>
%             }
              <a href="ip.html?id=<% $o %>&view=Zones&_action=VIEW_ADD_FZONES">[add]</a>
%	  }
%     }
      </div>
      <div class="containerbody">
%     if ( $_action eq 'VIEW_ADD_FZONES' ){
%         my $czone = ($o->forward_zone)? $o->forward_zone->name : "none";
%         my @all_zones = sort { $a->name cmp $b->name } Zone->retrieve_all;
%         my %cur_zones;
%         map { $cur_zones{$_->zone->id} = 1 } @sz; 
	  <form name="netdotform" action="ip.html" method="POST">
	    <input type="hidden" name="id" value="<% $o->id %>">
	    <input type="hidden" name="_action" value="LINK_ZONES">
	    <input type="hidden" name="view" value="Zones">
	    <p>Zones are inherited from superior blocks. The current forward zone for this block is:
	    <p>
%	    print "&nbsp;&nbsp;$czone";
            <p>Link this block with existing forward zones:
	    <p><select name="link_zones" multiple="multiple">
            <option value=""> - select - </option>
%	    foreach my $zone ( grep { $_->active == 1 && $_->name !~ /\.arpa$/ } @all_zones ){
%               next if exists $cur_zones{$zone->id};
                <option value="<% $zone->id %>"><% $zone->get_label %></option>
%	    }
            </select>
            <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
            <input type="submit" name="submit" value="save">
	  </form>
%     }else{
          <& /generic/sortresults.mhtml, object=>\@sz, return_args=>"?id=$id&view=$view", withedit=>($edit eq 'edit_fzones')? 1 : 0 &>
%     }
      </div>
      </div>
% }

%################################################################
%# Reverse Zones
%################################################################
% if ( $manager && $manager->can($user, "access_section", 'ip.html:edit_rzones') ){

%     my %all_zones;
%     map { $all_zones{$_->name} = $_ } Zone->retrieve_all;
%     my %reverse_zones;
%     foreach my $n ( $o->get_dot_arpa_names ){
%         if ( exists $all_zones{$n} ){
%             $reverse_zones{$n} = $all_zones{$n};
%         }
%     }
      <div class="container">
      <div class="containerheadleft">Reverse DNS Zones</div>
      <div class="containerheadright">
      &nbsp;
%     if ( $edit ne 'edit_fzones' ){
%         if ( $manager && $manager->can($user, 'edit', $o) ){
%             if ( %reverse_zones ){
                  <a href="ip.html?id=<% $o %>&view=Zones&edit=edit_rzones">[edit]</a>
%             }
              <a href="ip.html?id=<% $o %>&view=Zones&_action=VIEW_ADD_RZONES">[add]</a>
%	  }
%     }
      </div>
      <div class="containerbody">
%     if ( $_action eq 'VIEW_ADD_RZONES' ){
%         my @all_zones = sort { $a->name cmp $b->name } Zone->retrieve_all;
	  <form name="netdotform" action="ip.html" method="POST">
	    <input type="hidden" name="id" value="<% $o->id %>">
	    <input type="hidden" name="_action" value="ADD_REV_ZONE">
	    <input type="hidden" name="view" value="Zones">
            Create reverse zones for this block (existing zones not included):
            <p><select name="new_rev_zones" multiple="multiple">
            <option value=""> - select - </option>
%           foreach my $n ( $o->get_dot_arpa_names ){
%               next if exists $reverse_zones{$n};
                <option value="<% $n %>"><% $n %></option>
%           }
	    </select>
            <p>Use template zone (optional):
	    <select name="template_zone_for_rev">
            <option value="">-- Select --</option>
%	        foreach my $zone ( @all_zones ){
                    <option value="<% $zone->id %>"><% $zone->get_label %></option>
%	        }
            </select>
            <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
            <input type="submit" name="submit" value="create">
	  </form>
%     }else{
%         my @z = values %reverse_zones;
          <& /generic/sortresults.mhtml, object=>\@z, return_args=>"?id=$id&view=$view", withedit=>($edit eq 'edit_rzones')? 1 : 0 &>
%     }
      </div>
      </div>
% }

% }

%################################################################
%# Access Rights
%################################################################
% if ( $view eq 'Rights' || $view eq 'All' ){
%  if ( $manager && $manager->can($user, "access_section", 'ip.html:edit_rights') ){
<%perl>
my @arights = AccessRight->search(object_class=>'Ipblock', object_id=>"$o");
my @urights  = map { $_->user_rights  } @arights;
my @grights  = map { $_->group_rights } @arights;
my @all_rights = ( @urights, @grights);
</%perl>

      <div class="container">
      <div class="containerheadleft">Access Rights</div>
      <div class="containerheadright">
      &nbsp;
%     if ( $edit ne 'edit_rights' ){
%         if ( $manager && $manager->can($user, 'edit', $o) ){
%             if ( @all_rights ){
                  <a href="ip.html?id=<% $o %>&view=Rights&edit=edit_rights">[edit]</a>
%             }
              <a href="ip.html?id=<% $o %>&view=Rights&_action=VIEW_ADD_RIGHTS">[add]</a>
%	  }
%     }
      </div>
      <div class="containerbody">
<%perl>
if ( $_action eq 'VIEW_ADD_RIGHTS' ){
    my $user_type = $user->getAttribute('USER_TYPE');
    if ( $user_type eq "Admin" ) {
	my %ar = (showheader=>1, 
		  object_class=>'Ipblock', object_id=>$o->id, 
		  return_comp=>$m->current_comp->path, return_id=>$o->id, return_view=>$view);
	if ( $add_access_type && $add_access_id ){
	    $ar{$add_access_type} = $add_access_id;
	}
	$m->comp('/generic/access_right_form.html', %ar);
    }else {
	$m->comp('/generic/error.mhtml', error=>"You don't have permission to manage rights!");
    }
}elsif ( $edit eq 'edit_rights' ){
    $m->comp('/generic/sortresults.mhtml', object=>\@urights, withedit=>1, return_args=>"?id=$id&view=$view");
    $m->comp('/generic/sortresults.mhtml', object=>\@grights, withedit=>1, return_args=>"?id=$id&view=$view");
}elsif ( @all_rights ) {
    $m->comp('/management/list_rights.mhtml', rights=>\@all_rights, show_object=>0, 
	     add=>"ip.html?id=$id&view=Rights&_action=VIEW_ADD_RIGHTS&add_access_type=SUBJECT&add_access_id=ID");
}
</%perl>
      </div>
      </div>
%  }
% }

%################################################################
<!-- Display Custom Attributes -->
% if ( $view eq 'Attributes' || $view eq 'All' ){
%  if ( $manager && $manager->can($user, "access_section", 'ip.html:edit_attributes') ){
%      my @attributes = $o->attributes;
  <div class="container">
    <div class="containerheadleft"><strong>Custom Attributes</strong></div>
    <div class="containerheadright">
%     if ( @attributes ) {
        <a href="ip.html?id=<% $o %>&view=Attributes&editattr=1">[edit]</a>
%     }
%   if ( $manager && $manager->can($user, 'edit', $o) ){
        <a href="edit.html?table=IpblockAttr&ipblock=<% $o %>">[add]</a>
%   }else{
        &nbsp;
%   }
    </div>
    <div class="containerbody">
        <& /generic/sortresults.mhtml, object=>\@attributes, withedit=>$editattr, return_args=>"?id=$id" &>
    </div>
  </div>
<!-- End Display Custom Attributes -->
% }
%}


%################################################################
%# Graphical Views
%################################################################
% if ( ($view eq 'Children' || $view eq 'All') && ($edit eq 'address_range' || !$edit) ){
% if( $view_format eq 'block' ) {  
%     if( $o->status->name eq "Subnet" ) {  
       <div class="container">  
          <div class="containerheadleft"> 
              Subnet Block View 
          </div>  
          <div class="containerheadright">
              <a href="ip.html?id=<% $id %>&view=Children&view_format=list">[List View]</a>
          </div>
          <div class="containerbody" id="ipaddresstable">  
          <& subnet.mhtml, network => $o &>  
          </div>  
       </div>  
%     }  
%     if( $o->status->name eq "Container") {  
       <div class="container">  
          <div class="containerheadleft"> 
             Usage for <% $o->get_label %>  
          </div>  
          <div class="containerheadright">
            Legend:
            <span class="ipaddr_available">Available</span>
            <span class="ipaddr_container">Container</span>
            <span class="ipaddr_static">Static</span>
            <span class="ipaddr_reserved">Reserved</span>
			&nbsp;&nbsp;
         	<a href="ip.html?id=<% $id %>&view=Children&view_format=list">[List View]</a>
		<a href="ip.html?id=<% $id %>&view=Children&view_format=tree">[Tree View]</a>
          </div>
          <div class="containerbody" id="ipaddresstable">  
          <& container.mhtml, network => $o, rowsize => $rowsize, dividefreespace => $dividefreespace &>  
          </div>  
       </div>  
%     }  
% }elsif( $view_format eq 'tree' ) {  
%     if( $o->status->name eq "Subnet" || $o->status->name eq "Container" ) {  
       <div class="container">  
          <div class="containerheadleft"> 
             Tree View
          </div>  
          <div class="containerheadright">
            Legend:
            <span class="ipaddr_container">Container</span>
            <span class="ipaddr_static">Static</span>
            <span class="ipaddr_reserved">Reserved</span>
			&nbsp;&nbsp;
%	        if ( $o->version == 4 ){
%                   if ( $BLOCK_VIEW_MAX && ($o->prefix >= $BLOCK_VIEW_MAX) ){
         	        <a href="ip.html?id=<% $id %>&view=Children&view_format=block">[Block View]</a>
%                   }
%               }
         	<a href="ip.html?id=<% $id %>&view=Children&view_format=list">[List View]</a>
          </div>
          <div class="containerbody" id="ipaddresstable">  
          <& tree.mhtml, network => $o &>  
          </div>  
       </div>  
%     }  
<%perl>
} elsif ( $view_format eq 'list' ) {  
    my @children;
    if ( $o->status->name eq 'Subnet' && $ip_list_sort ne "Device" ){
	@children = $o->get_addresses_by($ip_list_sort);
    }else{
	@children = $o->children;
    }

</%perl>
       <div class="container">
%      if ( $edit_children ){
	     <form name="edit_children" id="edit_children" action="ip.html" method="POST">
%      }
          <div class="containerheadleft">
%      if ( $o->status->name eq 'Subnet' ){	      
             Addresses
%      }else{
             Contained IP blocks
%      }
          </div>
          <div class="containerheadright">
%	     if ( $edit_children ){
	         <input type="hidden" name="id" value="<% $id %>">
		 <input type="hidden" name="_action" value="UPDATE">
		 <input type="hidden" name="view" value="Children">
		 <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
		 <input type="submit" name="submit" value="save">
%	      }else{
%                 if ( @children && $manager && $manager->can($user, 'access_section', 'ip.html:edit_children') ){
%                     if ( $manager && $manager->can($user, 'edit', $o) ){
%		          print '<a href="ip.html?id='.$id.'&view=Children&edit_children=1&view_format=list'.
%                               '&sort=&ip_list_sort='.$ip_list_sort.'">[edit]</a>&nbsp;';
%                     }
%                 }
%                 if ( $o->version == 4 ) {
%                     if ( $BLOCK_VIEW_MAX && ($o->prefix >= $BLOCK_VIEW_MAX) ){
%                         print '<a href="ip.html?id='.$id.'&view=Children&view_format=block">[Block View]</a>';
%                     }
%                 }elsif ( $o->version == 6 ){
                      &nbsp;
%                 } 
%                 if ( $o->status->name eq 'Container' ){
                      <a href="ip.html?id=<% $id %>&view=Children&view_format=tree">[Tree View]</a>
%                 }
%             }
          </div>
          <div class="containerbody">
%         if ( @children ){ 
              <& ipblock_list.mhtml, parent=>$o, objects=>\@children, edit=>$edit_children, sort=>$ip_list_sort &>
%         }
%	  if ( $edit_children ){
                  <input type="button" value="Check All" onclick="setCheckbox('edit_children', '', true);return false;" class="button" />
                  <input type="button" value="Clear All" onclick="setCheckbox('edit_children', '', false);return false;" class="button" />
 		  <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
		  <input type="submit" name="submit" value="save">
%	  }
          </div>

%    if ( $edit_children ){
         </form>
%    }
     </div>

% }else{
%    $m->comp('/generic/error.mhtml', error => "Unknown view format: $view_format");
% }
<!-- End Block Info Table -->
% }

% }

% }
</div>

    </div>

</div>


<%def .show_message>
<%args>
$title => undef
$msg   => undef
</%args>

<div class="container">
    <div class="containerhead">
       <strong><% $title %></strong>
    </div>
    <div class="containerbody">
       <p><% $msg %></p>
    </div>
</div>

</%def>
